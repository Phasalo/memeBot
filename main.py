#
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀  ⠀⣴⣶⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀          ⢰⣶⣿⣿⣿⣿⣿⡆
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀ ⠀ ⢰⣿⡏⠀⠀⠀⢸⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀       ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀   ⢰⣿⡏⠀⠀⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⠀⠀⠀⣴⣿⣿⣿⣿⣿⣷⣤⣤⣤⣄⠀⣾⣿⠁⠀⠀⠀⣿⣿⣤⣤⣀⠀⠀⠀⠀⠀⣀⣠⣤⣤⣤⣤⣤⣤⣤⣤⣄⠀⠀⣠⣴⣶⣶⣶⣶⣦⡀⠀⠀⠀⣀⣠⣤⣤⣤⣤⣤⣤⣤⣄⣀⣿⡿⠀⠀⠀⢰⣿⡏⠀⢀⣀⣤⣤⣤⣤⣀
# ⠀     ⠀⠀⠀⠀⠀⢸⣿⡏⠀⠀⠀⠸⠟⠛⠛⠛⢿⣿⣿⡿⠀⠀⠀⢸⠿⠛⠛⠻⢿⣿⣄⠀⣴⣾⡿⠟⠛⠛⠛⠿⠛⠛⠛⢻⣿⡇⣸⣿⠟⠉⠉⠉⢹⣿⡇⣾⡿⠟⠛⠛⠛⠿⠛⠛⠛⢻⣿⣿⡏⠀⠀ ⣼⣿⣡⣶⣿⠿⠟⠛⠛⠻⢿⣿⣆
# ⠀     ⠀⠀⠀⠀⠀⣾⣿⠁⠀⠀⠀⣠⣤⡄⠀⠀⠀⢿⣿⠇⠀⠀⠀⢀⣀⡀⠀⠀⠀⢿⣿⣾⣿⠋⠀⠀⢀⣴⣶⡄⠀⠀⠀⣼⣿⢣⣿⡿⠀⠀⠀⠀⢸⣿⣷⣿⡿⠃⠀⠀⢠⣤⣤⠀⠀⠀⠀⣿⣿⣿⡏⠀⠀  ⣿⣿⣿⠟⠁⠀⠀⣤⣶⡄⠀⢻⣿⡄
# ⠀     ⠀⠀⠀⠀⢠⣿⡟⠀⠀⠀⢰⣿⣿⣿⠀⠀⠀⢸⣿⠀⠀⠀⢠⣾⣿⡇⠀⠀⠀⣾⣿⡿⠁⠀⠀⢠⣿⣿⣿⠁⠀⠀⠀⣿⣿⣿⣿⠁⣼⠀⠀⠀⠸⣿⣿⡟⠀⠀⠀⣰⣿⣿⡟⠀⠀⠀⢸⣿⣿⡏⠀⠀⠀⣼⣿⣿⠋⠀⠀⠀⣼⣿⣿⡇⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⠀⣸⣿⠇⠀⠀⠀⣾⣿⣿⡏⠀⠀⠀⣼⡇⠀⠀⠀⣸⣿⣿⠁⠀⠀⢠⣿⣿⠇⠀⠀⠀⣾⣿⣿⡟⠀⠀⠀⢸⣿⣿⣿⠃⣰⣿⠀⠀⠀⠀⣿⡿⠀⠀⠀⢠⣿⣿⣿⠇⠀⠀⠀⣾⣿⣿⠁⠀⠀⠀⣿⣿⡏⠀⠀⠀⢸⣿⣿⣿⠃⠀⢸⣿⡇
# ⠀     ⠀⠀⠀⢀⣿⣿⠀⠀⠀⢠⣿⣿⣿⠁⠀⠀⢀⣿⠀⠀⠀⢀⣿⣿⡏⠀⠀⠀⣸⣿⣿⠀⠀⠀⢰⣿⣿⣿⠃⠀⠀⠀⣿⣿⡟⠃⠀⣿⣿⠀⠀⠀⠀⣿⡇⠀⠀⠀⢸⣿⣿⡿⠀⠀⠀⢠⣿⣿⡟⠀⠀⠀⢸⣿⣿⠁⠀⠀⠀⣿⣿⣿⡟⠀⠀⣾⣿⠁
# ⠀     ⠀⠀⠀⢸⣿⡇⠀⠀⠀⢼⣿⡿⠃⠀⠀⢀⣼⡟⠀⠀⠀⢸⣿⣿⡇⠀⠀⠀⢿⣿⠏⠀⠀⠀⠘⢿⡿⠏⠀⠀⠀⠀⣿⡿⠀⢠⣤⣿⡿⠀⠀⠀⠀⠋⡀⠀⠀⠀⠸⣿⡿⠃⠀⠀⠀⢸⣿⡿⠁⠀⠀⠀⢿⣿⠟⠀⠀⠀⠀⢿⣿⡟⠁⠀⣼⣿⡏
# ⠀     ⠀⠀⠀⣾⣿⠁⠀⠀⠀⠀⠀⠀⠀⢀⣠⣾⣿⠃⠀⠀⠀⣿⣿⣿⣧⠀⠀⠀⠀⠀⣠⣆⠀⠀⠀⠀⢀⣴⣆⠀⠀⠀⠀⣀⣤⠀⠉⠉⠀⠀⠀⣠⣴⣿⣷⡀⠀⠀⠀⠀⢀⣴⡀⠀⠀⠀⠀⣠⣆⠀⠀⠀⠀⠀⣠⣦⡀⠀⠀⠀  ⠀⠀⣠⣾⣿⠏
# ⠀     ⠀⠀⢰⣿⡏⠀⠀⠀⢸⣿⣶⣶⣿⣿⡿⢿⣿⣷⣶⣶⣾⣿⠏⠙⢿⣿⣶⣶⣾⣿⡿⢿⣿⣶⣶⣾⣿⡿⣿⣷⣶⣶⣿⣿⢿⣿⣶⣶⣶⣾⣿⡿⠟⠉⠻⣿⣷⣶⣶⣾⣿⢿⣿⣶⣶⣶⣿⡿⣿⣷⣶⣶⣶⣿⡿⡿⠟
# ⠀     ⠀⠀⣼⣿⠃⠀⠀⠀⣿⣿⠉
# ⠀     ⠀⢰⣿⡿⠀⠀⠀⢰⣿⡏
# ⠀     ⠀⣾⣿⣷⣶⣶⣿⣿⠿⠁⠀⠀⠀⠀⠀⢀⣶⠿⢿⣶⢀⣶⡆⢀⣶⠆⢠⣾⣿⠀⢀⣴⣶⠿⠇⠀⣾⢿⡇⠀⣴⡿⠀⢀⣴⣶⣷⣶⡄⢀⣾⠿⢿⣦⢀⣶⡾⠿⠇⣾⡿⢿⣶⠀⣴⣶⠀⣴⣿⣷⠀⠀⠀⢠⣾⠿⣿⣦⢀⣶⠆⢰⣿⠂
#                 ⠀⠀⠀⠀⠀⠀⣼⣿⣤⣾⠟⣸⣿⣶⣾⡟⢠⣿⣃⣿⡇⠘⢿⣧⡀⠀⣼⣏⣸⡇⢠⣿⠃⠀⣾⡟⠁⠈⣿⠇⣼⣿⣤⣾⠏⣸⡿⠶⠆⢸⣿⠁⣸⣿⢠⣿⠇⣸⣟⣸⣿⠀⠀⠀⣾⣿⣤⡿⠋⣼⡟⠀⣾⡏
# ⠀     ⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⠋⠉⠀⠀⣿⠇⠠⠿⠃⠿⠛⠻⣿⠡⣶⣶⠿⠟⠼⠟⠛⣿⡇⣾⣿⡶⠆⠻⢿⣶⠾⠋⢠⣿⠋⠉⠀⠠⠿⠷⠶⠀⢿⣷⠾⠟⠁⣼⡟⠰⠿⠛⢻⡿⠠⡶⢰⡿⠉⢿⠇⠀⢿⣷⣾⠟⠁
#

import asyncio
from aiogram import Dispatcher

from config import bot
from bot.middlewares.get_user import GetUserMiddleware
from bot.middlewares.shadow_ban import ShadowBanMiddleware
from bot import handlers
from DB import init_database
import logging

logger = logging.getLogger(__name__)


async def main() -> None:
    logger.info('Creating db tables')
    init_database()

    dp = Dispatcher()

    logger.info('Including routers')
    dp.include_router(handlers.admin.router)
    dp.include_router(handlers.default.router)
    dp.include_router(handlers.callbacks.router)

    logger.info('Including middlewares')
    dp.update.middleware(GetUserMiddleware())
    dp.update.middleware(ShadowBanMiddleware())

    logger.info(f'{(await bot.get_me()).first_name} starting\n * Running on http://t.me/{(await bot.get_me()).username}')
    try:
        await dp.start_polling(bot)
    except Exception as e:
        logger.exception(e)


if __name__ == '__main__':
    asyncio.run(main())
